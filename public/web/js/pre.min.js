$(document).ready(function(){
var times=0;//倒计时
var phone=getlocalStorage("phone");
var strUrl=window.location.href;
var arrUrl=strUrl.split("?");
var strPage1=arrUrl[0];
var arrUrl=strPage1.split("/");
var strPage=arrUrl[arrUrl.length-1];
if(phone==null||phone=="null"||phone==undefined||phone=="undefined"||phone==""){//判断登录
	if(strPage != "login.html") {
			$.alert("登录无效,请重新登录!", function() {
				window.location.href = "login.html"
			});
			return
	}
}
if(strPage=="login.html"){//初始化页面
	$("#usercode").val("");
	$("#userphone").val("");
	$(".getcodebtn").addClass('postcodebg')
}else{
	$(".weui-check").prop('checked',false);	
}
pageinit()
function pageinit(){//入口文件
//获取登录页的数据缓存
	var registration_notes=getlocalStorage("registration_notes");
	if(strPage=="pre1.html"){
		$(".pre1 .content").html(registration_notes);
	}
	var frozen=getlocalStorage("frozen");
	if(strPage=="pre2.html"){
		$(".pre2 .content").html(frozen);
	}
	var notice=getlocalStorage("notice");
	if(strPage=="pre3.html"){
		$(".pre3 .content").html(notice);
	}		

//获取登录页的数据缓存结束
	var posturl=ajaxurl;
	var data1={
		"phone":phone
	}
	if(strPage=="login.html"){//登录页无phone
		data1={}
	}
	$.ajax({
			url:posturl+"/api/config",
			type:"post",
			async:false,
			data:data1,
			success:function(obj){
				console.log(obj)
				if(obj.code==200){
					setlocalStorage("registration_notes",obj.data.registration_notes);
					setlocalStorage("frozen",obj.data.frozen);
					setlocalStorage("notice",obj.data.notice);
					if(strPage=="login.html"){
						$(".pagepreicon").attr("src",obj.data.img);
						$('title').html(obj.data.project_name+'线上登记')
					}
					if(strPage=="pre1.html"){
						$(".pre1 .content").html(obj.data.registration_notes)
					}
					if(strPage=="pre2.html"){
						$(".pre2 .content").html(obj.data.frozen)
					}
					if(strPage=="pre3.html"){
						$(".pre3 .content").html(obj.data.notice)
						$(".pre3").attr("status",obj.data.status);
					}
				}else{
					 $.alert(obj.msg,function(){
						if(strPage!="login.html"&&obj.msg=='登录失效,请重新登录'){
							var v=Math.random();
						    window.location.href="login.html?v="+v;
					     }
					})
				}
			},
			error:function(){
				$(".pagepre .btn").addClass("btnok");
	            $.alert("请检查您的网络，稍后再试！","提示",function(){
	            	console.log('掉接口失败')
	            })
			}
	});	
}
$('#userphone').bind('input propertychange', function() {//手机号码输入
	    var phone = $('#userphone').val();
		if(phone){
			phone = phone.replace(/\s/g, "");
			$(".pagepre .btn").removeClass("btnok");
		}
		if(phone.length != 11) {
			$(".getcodebtn").addClass('postcodebg')
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$(".pagepre .btn").removeClass("btnok");
			$(".getcodebtn").addClass('postcodebg')
			return
		}
		if(times==0){
			$(".getcodebtn").removeClass('postcodebg');
		}
});
$('#usercode').bind('input propertychange', function(){//验证码输入
	    var phone = $('#userphone').val();
		if(phone) {
			phone = phone.replace(/\s/g, "");
			$(".pagepre .btn").removeClass("btnok");
		}
		if(phone.length != 11) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	    var phone = $('#usercode').val();
		if(phone=="") {
			$(".pagepre .btn").removeClass("btnok");
		}else{
			phone = phone.replace(/\s/g, "");
		}
		if(phone.length!= 4) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		$(".pagepre .btn").addClass("btnok");
});

$(".getcodebtn").click(function(){//点击验证码
		if(times!=0){
			return;
		}
	    var phone = $('#userphone').val();
	    console.log(phone);
		if(phone==""){
			$.alert("请输入有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return;
		}else{
			phone = phone.replace(/\s/g, "");
		}
		console.log(phone);
		if(phone.length != 11) {
			$.alert("请输入11位有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		console.log(phone);
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$.alert("请输入有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	var posturl=ajaxurl;
	$.ajax({
		url:posturl+"/api/send",
		type:"post",
		async:false,
		data:{
			"phone":phone
		},
		success:function(obj){
			if(obj.code==200){
				times=60;
				time60();
				$(".getcodebtn").addClass("postcodebg");
				$('.getcodebtn').html(times + '秒后获取')
				$.toast("发送成功", 1200);
			}else{
				$.alert(obj.msg)
			}
		},
		error:function(){
            $.alert("请检查您的网络，稍后再试！","提示",function(){
            	
            })
		}
	});	
})
function time60() {//60秒倒计时
	setTimeout(function() {
		times=times-1;
		if(times >0) {
			time60();
			$(".getcodebtn").addClass("postcodebg");
			$('.getcodebtn').html(times + '秒后获取')
		}else{
			times = 0;
			console.log(223)
			$(".getcodebtn").removeClass("postcodebg");
			$('.getcodebtn').html('发送验证码')
		}
	}, 1000)
}
$(".pagepre").on('click', ".btnok", function(){//点击提交
        var phone = $('#userphone').val();
		if(phone){
			phone = phone.replace(/\s/g, "");
			$(".pagepre .btn").removeClass("btnok");
		}
		if(phone.length != 11) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	    var code = $('#usercode').val();
		if(code=="") {
			$(".pagepre .btn").removeClass("btnok");
		}else{
			code = code.replace(/\s/g, "");
		}
		if(code.length!= 4) {
			$.alert("请输入4位验证码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
    var posturl=ajaxurl;
    $(".pagepre .btn").removeClass("btnok");
    var v=Math.random();
    var sign=md5(phone+code+v);
    var timestamp =(new Date()).valueOf();
    var phonenum=md5(phone);
	$.ajax({
		url:posturl+"/api/check",
		type:"post",
		async:false,
		data:{
			"phone":phone,
			"code":code,
			"sign":sign
		},
		success:function(obj){
			console.log(obj)
			if(obj.code==200){
				console.log(obj)
				setlocalStorage("signtime",timestamp)
			    setlocalStorage("phone",sign)
			    setlocalStorage("phonenum",phonenum);
				$.toast("登录成功", 1200,function(){
					if(obj.status=='不跳'){
						window.location.href="pre1.html";
					}else{
						window.location.href="showdata.html";
					}
				});
			}else{
				 $.alert(obj.msg,"提示",function(){})
			}
		},
		error:function(){
			$(".pagepre .btn").addClass("btnok");
            $.alert("请检查您的网络，稍后再试！","提示",function(){
            	
            })
		}
	});	
})		
})
