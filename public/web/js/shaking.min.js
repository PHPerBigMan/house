$(document).ready(function(){
$("#usercode").val("");
$("#userphone").val("");
var times=0;//倒计时
var phone=getlocalStorage("phone");
pageInit(posturl);
function pageInit(posturl){
	$.ajax({
		url:posturl+"/api/config",
		type:"post",
		async:false,
		data:{},
		success:function(obj){
			console.log(obj)
			if(obj.code==200){
				$(".pagepreicon").attr("src",obj.data.img);
			}else{
				 $.alert(obj.msg,"提示",function(){})
			}
		},
		error:function(){
			$(".pagepre .btn").addClass("btnok");
            $.alert("请检查您的网络，稍后再试！","提示",function(){
            	
            })
		}
    });	
}
$('#userphone').bind('input propertychange', function() {//手机号码输入
	    var phone = $('#userphone').val();
		if(phone){
			phone = phone.replace(/\s/g, "");
			$(".pagepre .btn").removeClass("btnok");
		}
		if(phone.length != 11) {
			$(".getcodebtn").addClass('postcodebg')
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$(".pagepre .btn").removeClass("btnok");
			$(".getcodebtn").addClass('postcodebg')
			return
		}
		if(times==0){
			$(".getcodebtn").removeClass('postcodebg');
		}
});
$('#usercode').bind('input propertychange', function(){//验证码输入
	    var phone = $('#userphone').val();
		if(phone) {
			phone = phone.replace(/\s/g, "");
			$(".pagepre .btn").removeClass("btnok");
		}
		if(phone.length != 11) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	    var phone = $('#usercode').val();
		if(phone=="") {
			$(".pagepre .btn").removeClass("btnok");
		}else{
			phone = phone.replace(/\s/g, "");
		}
		if(phone.length!= 4) {
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		$(".pagepre .btn").addClass("btnok");
});

$(".getcodebtn").click(function(){//点击验证码
		if(times!=0){
			return;
		}
	    var phone = $('#userphone').val();
	    console.log(phone);
		if(phone==""){
			$.alert("请输入有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return;
		}else{
			phone = phone.replace(/\s/g, "");
		}
		console.log(phone);
		if(phone.length != 11) {
			$.alert("请输入11位有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
		console.log(phone);
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			$.alert("请输入有效手机号码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	$.ajax({
		url:ajaxurl+"/api/send",
		type:"post",
		async:false,
		data:{
			"phone":phone
		},
		success:function(obj){
			if(obj.code==200){
				times=60;
				time60();
				$(".getcodebtn").addClass("postcodebg");
				$('.getcodebtn').html(times + '秒后获取')
				$.toast("发送成功", 1200);
			}else{
				$.alert(obj.msg)
			}
		},
		error:function(){
            $.alert("请检查您的网络，稍后再试！","提示",function(){
            	
            })
		}
	});	
})
function time60() {//60秒倒计时
	setTimeout(function() {
		times=times-1;
		if(times >0) {
			time60();
			$(".getcodebtn").addClass("postcodebg");
			$('.getcodebtn').html(times + '秒后获取')
		}else{
			times = 0;
			console.log(223)
			$(".getcodebtn").removeClass("postcodebg");
			$('.getcodebtn').html('发送验证码')
		}
	}, 1000)
}

$(".btn").click(function(){
        var phone = $('#userphone').val();
		if(phone==''){
			phone = phone.replace(/\s/g, "");
			$.alert("请输入手机号码",'售房派');
			return
		}
		if(phone.length!= 11) {
		    $.alert("手机号码不是11位",'售房派');
			return
		}
		if(!(/^1[3|4|5|7|8|6|9][0-9]\d{4,8}$/.test(phone))) {
			 $.alert("手机号码无效",'售房派');
			return
		}
		var code = $('#usercode').val();
		if(code=="") {
			$(".pagepre .btn").removeClass("btnok");
		}else{
			code = code.replace(/\s/g, "");
		}
		if(code.length!= 4) {
			$.alert("请输入4位验证码");
			$(".pagepre .btn").removeClass("btnok");
			return
		}
	$.ajax({
		url:posturl+"/api/result",
		type:"post",
		async:false,
		data:{
			"phone":phone,
			"code":code
		},
		success:function(obj){
			if(obj.code==200){
				   setlocalStorage("resultphone",obj.sign);
					window.location.replace("shakresult.html?name="+escape(obj.name)+'&result='+escape(obj.result)+'&idCard='+obj.idCard);
			}else{
				 $.alert(obj.msg,"提示",function(){})
			}
		},
		error:function(){
			$(".pagepre .btn").addClass("btnok");
            $.alert("请检查您的网络，稍后再试！","提示",function(){
            	
            })
		}
	});	
})		
})
